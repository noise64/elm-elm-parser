def build = "build"
def buildElmMain = "${build}/elm-main"
def buildElmTest = "${build}/elm-test"
def buildElmMainIo = "${build}/elm-main-io"
def buildElmTestIo = "${build}/elm-test-io"

def elmIoBuildScript = "./elm-stuff/packages/maxsnew/IO/1.0.0/elm-io.sh"

def mainElm = "Main.elm"
def mainJs = "main.js"

def testElm = "Test.elm"
def testJs = "test.js"

task(cleanBuild, type: Delete) {
    delete 'build'
}

task(cleanElmStuff, type: Delete) {
    delete 'elm-stuff'
}

task(cleanNodeModules, type: Delete) {
    delete 'node_modules'
}

task(clean) {
    dependsOn cleanBuild
    dependsOn cleanElmStuff
    dependsOn cleanNodeModules
}

task(installNodeDependencies, type: Exec) {
    commandLine "npm", "install"
}

task(installElmDependencies, type: Exec) {
    commandLine "elm-package", "install", "-y"
}

task(buildElmMain, type: Exec) {
    dependsOn installElmDependencies

    commandLine "elm-make", "src/main/elm/${mainElm}", "--output", "${buildElmMain}/${mainJs}"
}

task(buildElmTest, type: Exec) {
    dependsOn installElmDependencies

    commandLine "elm-make", "src/test/elm/${testElm}", "--output", "${buildElmTest}/${testJs}"
}

task(mkdirBuildElmMainIo) {
    doLast {
        new File(buildElmMainIo).mkdirs();
    }
}

task(mkdirBuildElmTestIo) {
    doLast {
        new File(buildElmTestIo).mkdirs();
    }
}

task(buildElmMainIo, type: Exec) {
    dependsOn buildElmMain
    dependsOn installElmDependencies
    dependsOn mkdirBuildElmMainIo

    commandLine "sh", "${elmIoBuildScript}", "${buildElmMain}/${mainJs}", "${buildElmMainIo}/${mainJs}"
}

task(buildElmTestIo, type: Exec) {
    dependsOn buildElmTest
    dependsOn installElmDependencies
    dependsOn mkdirBuildElmTestIo

    commandLine "sh", "${elmIoBuildScript}", "${buildElmTest}/${testJs}", "${buildElmTestIo}/${testJs}"
}

task(build) {
    dependsOn buildElmMainIo
}

task(runNodeTest, type: Exec) {
    dependsOn buildElmTestIo
    dependsOn installNodeDependencies

    commandLine "node", "${buildElmTestIo}/${testJs}"
}

task(test) {
    dependsOn runNodeTest
}

task(runNodeMain, type: Exec) {
    dependsOn buildElmMainIo
    dependsOn installNodeDependencies

    commandLine "node", "${buildElmMainIo}/${mainJs}"
}

task(run) {
    dependsOn runNodeMain
}

task(wrapper, type: Wrapper) {
    gradleVersion = '2.2'
}